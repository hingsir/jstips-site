<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>JsTips - Useful JavaScript Tips</title><meta name="keywords" content="jstips,tips,Useful JavaScript Tips"><meta name="description" content="Introduces these short and useful daily JavaScript tips that will allow you to improve your code writing. With less than 2 minutes each day, you will be able to read about performance, conventions, hacks, interview questions and all the items that the future of this awesome language holds for us"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scale=no"><link rel="icon" type="image/x-icon" href="../../images/favicon.ico"><link rel="stylesheet" type="text/css" href="../../css/all-7e45beae0a.min.css"><script type="text/javascript">window.onload = function(){
                document.getElementById('J_languages_select').onchange = function(){
                var lang = this.value;
                window.location.href = window.location.href.replace(/tips\/(\w+)\//,function($,$1){
                    return $.replace($1,lang);
                })
            }
        }</script></head><body><div class="main-content clearfix"><div id="sider-wrap" class="catalog"><div class="catalog-header"><h1><a href="https://github.com/loverajoel/jstips">Useful JS Tips</a></h1><select id="J_languages_select"><option value="en" selected="selected">English</option><option value="zh_CN">简体中文</option><option value="zh_TW">繁体中文</option></select></div><ul><li><a href="working-with-websocket-timeout" class="" title="63.Working With Websocket Timeout">63.Working With Websocket Timeout</a></li><li><a href="preventing-unwanted-scopes-creation-in-angularjs" class="" title="62.Preventing Unwanted Scopes Creation in AngularJs">62.Preventing Unwanted Scopes Creation in AngularJs</a></li><li><a href="binding-objects-to-functions" class="" title="61.Binding objects to functions">61.Binding objects to functions</a></li><li><a href="three-useful-hacks" class="" title="60.Three useful hacks">60.Three useful hacks</a></li><li><a href="keyword-var-vs-let" class="" title="59.ES6, var vs let">59.ES6, var vs let</a></li><li><a href="break-continue-loop-functional" class="" title="58.Breaking or continuing loop in functional programming">58.Breaking or continuing loop in functional programming</a></li><li><a href="comma-operaton-in-js" class="" title="57.Comma operator in JS">57.Comma operator in JS</a></li><li><a href="copy-to-clipboard" class="" title="56.Copy to Clipboard">56.Copy to Clipboard</a></li><li><a href="make-easy-loop-on-array" class="" title="55.Create an easy loop using an array">55.Create an easy loop using an array</a></li><li><a href="use-optional-arguments" class="" title="54.How to use optional arguments in functions (with optional callback)">54.How to use optional arguments in functions (with optional callback)</a></li><li><a href="get-file-extension" class="" title="53.Get File Extension">53.Get File Extension</a></li><li><a href="return-values-with-the-new-operator" class="" title="52.Return Values with the &#39;new&#39; Operator">52.Return Values with the &#39;new&#39; Operator</a></li><li><a href="DOM-event-listening-made-easy" class="" title="51.DOM event listening made easy">51.DOM event listening made easy</a></li><li><a href="helpful-console-log-hacks" class="" title="50.Helpful Console Logging Tricks">50.Helpful Console Logging Tricks</a></li><li><a href="extract-unix-timestamp-easily" class="" title="49.Easiest way to extract unix timestamp in JS">49.Easiest way to extract unix timestamp in JS</a></li><li><a href="reminders-about-reduce-function-usage" class="" title="48.How to `reduce()` arrays">48.How to `reduce()` arrays</a></li><li><a href="basics-declarations" class="" title="47.Basics declarations">47.Basics declarations</a></li><li><a href="detect-document-ready-in-pure-js" class="" title="46.Detect document ready in pure JS">46.Detect document ready in pure JS</a></li><li><a href="calculate-the-max-min-value-from-an-array" class="" title="45.Calculate the Max/Min value from an array">45.Calculate the Max/Min value from an array</a></li><li><a href="know-the-passing-mechanism" class="" title="44.Know the passing mechanism">44.Know the passing mechanism</a></li><li><a href="use-destructuring-in-function-parameters" class="" title="43.Use destructuring in function parameters">43.Use destructuring in function parameters</a></li><li><a href="preventing-unapply-attacks" class="" title="42.Preventing Unapply Attacks">42.Preventing Unapply Attacks</a></li><li><a href="array-average-and-median" class="" title="41.Array average and median">41.Array average and median</a></li><li><a href="using-json-stringify" class="" title="40.Using JSON.Stringify">40.Using JSON.Stringify</a></li><li><a href="advanced-properties" class="" title="39.Advanced Javascript Properties">39.Advanced Javascript Properties</a></li><li><a href="flattening-multidimensional-arrays-in-javascript" class="" title="38.Flattening multidimensional Arrays in JavaScript">38.Flattening multidimensional Arrays in JavaScript</a></li><li><a href="deduplicate-an-array" class="" title="37.Deduplicate an Array">37.Deduplicate an Array</a></li><li><a href="observe-dom-changes" class="" title="36.Observe DOM changes in extensions">36.Observe DOM changes in extensions</a></li><li><a href="assignment-shorthands" class="" title="35.Assignment Operators">35.Assignment Operators</a></li><li><a href="implementing-asynchronous-loops" class="" title="34.Implementing asynchronous loop">34.Implementing asynchronous loop</a></li><li><a href="create-range-0...n-easily-using-one-line" class="" title="33.Create array sequence `[0, 1, ..., N-1]` in one line">33.Create array sequence `[0, 1, ..., N-1]` in one line</a></li><li><a href="map-to-the-rescue-adding-order-to-object-properties" class="" title="32.Map() to the rescue; adding order to Object properties">32.Map() to the rescue; adding order to Object properties</a></li><li><a href="avoid-modifying-or-passing-arguments-into-other-functions—it-kills-optimization" class="" title="31.Avoid modifying or passing `arguments` into other functions — it kills optimization">31.Avoid modifying or passing `arguments` into other functions — it kills optimization</a></li><li><a href="converting-truthy-falsy-values-to-boolean" class="" title="30.Converting truthy/falsy values to boolean">30.Converting truthy/falsy values to boolean</a></li><li><a href="speed-up-recursive-functions-with-memoization" class="" title="29.Speed up recursive functions with memoization">29.Speed up recursive functions with memoization</a></li><li><a href="curry-vs-partial-application" class="" title="28.Currying vs partial application">28.Currying vs partial application</a></li><li><a href="short-circuit-evaluation-in-js" class="" title="27.Short circuit evaluation in JS.">27.Short circuit evaluation in JS.</a></li><li><a href="filtering-and-sorting-a-list-of-strings" class="" title="26.Filtering and Sorting a List of Strings">26.Filtering and Sorting a List of Strings</a></li><li><a href="Using-immediately-invoked-function-expression" class="" title="25.Using immediately invoked function expression">25.Using immediately invoked function expression</a></li><li><a href="use_===_instead_of_==" class="" title="24.Use === instead of ==">24.Use === instead of ==</a></li><li><a href="converting-to-number-fast-way" class="" title="23.Converting to number fast way">23.Converting to number fast way</a></li><li><a href="two-ways-to-empty-an-array" class="" title="22.Two ways to empty an array">22.Two ways to empty an array</a></li><li><a href="shuffle-an-array" class="" title="21.Shuffle an Array">21.Shuffle an Array</a></li><li><a href="return-objects-to-enable-chaining-of-functions" class="" title="20.Return objects to enable chaining of functions">20.Return objects to enable chaining of functions</a></li><li><a href="safe-string-concatenation" class="" title="19.Safe string concatenation">19.Safe string concatenation</a></li><li><a href="rounding-the-fast-way" class="cur" title="18.Truncating the fast (but risky) way">18.Truncating the fast (but risky) way</a></li><li><a href="nodejs-run-a-module-if-it-is-not-required" class="" title="17.Node.js - Run a module if it is not `required`">17.Node.js - Run a module if it is not `required`</a></li><li><a href="passing-arguments-to-callback-functions" class="" title="16.Passing arguments to callback functions">16.Passing arguments to callback functions</a></li><li><a href="even-simpler-way-of-using-indexof-as-a-contains-clause" class="" title="15.Even simpler way of using `indexOf` as a contains clause">15.Even simpler way of using `indexOf` as a contains clause</a></li><li><a href="fat-arrow-functions" class="" title="14.Fat Arrow Functions">14.Fat Arrow Functions</a></li><li><a href="tip-to-measure-performance-of-a-javascript-block" class="" title="13.Tip to measure performance of a javascript block">13.Tip to measure performance of a javascript block</a></li><li><a href="pseudomandatory-parameters-in-es6-functions" class="" title="12.Pseudomandatory parameters in ES6 functions">12.Pseudomandatory parameters in ES6 functions</a></li><li><a href="hoisting" class="" title="11.Hoisting">11.Hoisting</a></li><li><a href="check-if-a-property-is-in-a-object" class="" title="10.Check if a property is in a Object">10.Check if a property is in a Object</a></li><li><a href="template-strings" class="" title="09.Template Strings">09.Template Strings</a></li><li><a href="converting-a-node-list-to-an-array" class="" title="08.Converting a Node List to an Array">08.Converting a Node List to an Array</a></li><li><a href="use-strict-and-get-lazy" class="" title="07.use strict and get lazy">07.use strict and get lazy</a></li><li><a href="writing-a-single-method-for-arrays-and-a-single-element" class="" title="06.Writing a single method for arrays and a single element">06.Writing a single method for arrays and a single element</a></li><li><a href="differences-between-undefined-and-null" class="" title="05.Differences between `undefined` and `null`">05.Differences between `undefined` and `null`</a></li><li><a href="sorting-strings-with-accented-characters" class="" title="04.Sorting strings with accented characters">04.Sorting strings with accented characters</a></li><li><a href="improve-nested-conditionals" class="" title="03.Improve Nested Conditionals">03.Improve Nested Conditionals</a></li><li><a href="keys-in-children-components-are-important" class="" title="02.Keys in children components are important">02.Keys in children components are important</a></li><li><a href="angularjs-digest-vs-apply" class="" title="01.AngularJs - `$digest` vs `$apply`">01.AngularJs - `$digest` vs `$apply`</a></li><li><a href="insert-item-inside-an-array" class="" title="00.Insert item inside an Array">00.Insert item inside an Array</a></li></ul></div><div id="content-wrap"><div id="readme" class="boxed-group clearfix announce instapaper_body md"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><h2>#18 - Truncating the fast (but risky) way</h2><blockquote><p>2016-01-18 by <a href="https://github.com/pklinger">@pklinger</a></p></blockquote><p>This tip is about performance…with a hidden price tag.</p><p>Have you ever come across the <a href="http://stackoverflow.com/questions/5971645/what-is-the-double-tilde-operator-in-javascript">double tilde <code>~~</code> operator</a>? It’s also often called the “double bitwise NOT” operator. You can often use it as a faster substitute for <code>Math.trunc()</code>. Why is that?</p><p>One bitwise shift <code>~</code> first truncates <code>input</code> to 32 bits, then transforms it into <code>-(input+1)</code>. The double bitwise shift therefore transforms the input into <code>-(-(input + 1)+1)</code> making it a great tool to round towards zero. For numeric input, it therefore mimics <code>Math.trunc()</code>. On failure, <code>0</code> is returned, which might come in handy sometimes instead of <code>Math.trunc()</code>, which returns <code>NaN</code> on failure.</p><pre><code class="language-js"><span class="hljs-comment">// single ~</span>
console.<span class="hljs-built_in">log</span>(~<span class="hljs-number">1337</span>)    <span class="hljs-comment">// -1338</span>

<span class="hljs-comment">// numeric input</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~47.11)  // -&gt;</span> <span class="hljs-number">47</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~1.9999) // -&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~3)      // -&gt;</span> <span class="hljs-number">3</span>
</code></pre><p>However, while <code>~~</code> is probably a better performer, experienced programmers often stick with <code>Math.trunc()</code> instead. To understand why, here’s a clinical view on this operator.</p><h3>INDICATIONS</h3><h5>When every CPU cycle counts</h5><p><code>~~</code> is probably faster than <code>Math.trunc()</code> across the board, though you should <a href="https://jsperf.com/jsfvsbitnot/10">test that assumption</a> on whichever platforms matter to you. Also, you’d generally have to perform millions of such operations to have any visible impact at run time.</p><h5>When code clarity is not a concern</h5><p>If you’re trying to confuse others, or get maximum utility from your minifier/uglifier, this is a relatively cheap way to do it.</p><h3>CONTRAINDICATIONS</h3><h5>When your code needs to be maintained</h5><p>Code clarity is of great importance in the long term, whether you work in a team, contribute to public code repos, or fly solo. As <a href="http://c2.com/cgi/wiki?CodeForTheMaintainer">the oft-quoted saying</a> goes:</p><blockquote><p>Always code as if the person who ends up maintaining your code is a violent psychopath who knows where you live.</p></blockquote><p>For a solo programmer, that psychopath is inevitably “you in six months”.</p><h5>When you forget that <code>~~</code> always rounds to zero</h5><p>Newbie programmers may fixate on the cleverness of <code>~~</code>, forgetting the significance of “just drop the fractional portion of this number”. This can easily lead to <strong>fencepost errors</strong> (a.k.a. “off-by-one”) when transforming floats to array indices or related ordinal values, where a different kind of fractional rounding may actually be called for. (Lack of code clarity usually contributes to this problem.)</p><p>For instance, if you’re counting numbers on a “nearest integer” basis, you should use <code>Math.round()</code> instead of <code>~~</code>, but programmer laziness and the impact of <strong><em>10 whole characters saved per use</em></strong> on human fingers often triumph over cold logic, leading to incorrect results.</p><p>In contrast, the very names of the <code>Math.xyz()</code> functions clearly communicate their effect, reducing the probability of accidental errors.</p><h5>When dealing with large-magnitude numbers</h5><p>Because <code>~</code> first does a 32-bit conversion, <code>~~</code> results in bogus values around ±2.15 billion. If you don’t properly range-check your input, a user could trigger unexpected behavior when the transformed value ends up being a great distance from the original:</p><pre><code class="language-js"><span class="hljs-keyword">a</span> = <span class="hljs-number">2147483647.123</span> <span class="hljs-comment"> // maximum positive 32-bit integer, plus a bit more</span>
console.<span class="hljs-built_in">log</span>(~~<span class="hljs-keyword">a</span>)   <span class="hljs-comment"> // -&gt;  2147483647     (ok)</span>
<span class="hljs-keyword">a</span> += <span class="hljs-number">10000</span>         <span class="hljs-comment"> // -&gt;  2147493647.123 (ok)</span>
console.<span class="hljs-built_in">log</span>(~~<span class="hljs-keyword">a</span>)   <span class="hljs-comment"> // -&gt; -2147483648     (huh?)</span>
</code></pre><p>One particularly vulnerable area involves dealing with Unix epoch timestamps (measured in seconds from 1 Jan 1970 00:00:00 UTC). A quick way to get such values is:</p><pre><code class="language-js">epoch_int = ~~(+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() / <span class="hljs-number">1000</span>)  <span class="hljs-comment">// Date() epochs in milliseconds, so we scale accordingly</span>
</code></pre><p>However, when dealing with timestamps after 19 Jan 2038 03:14:07 UTC (sometimes called the <strong>Y2038 limit</strong>), this breaks horribly:</p><pre><code class="language-js"><span class="hljs-comment">// epoch timestamp for 1 Jan 2040 00:00:00.123 UTC</span>
epoch = +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2040-01-01'</span>) / <span class="hljs-number">1000</span> + <span class="hljs-number">0.123</span>      <span class="hljs-comment">// -&gt;  2208988800.123</span>

<span class="hljs-comment">// back to the future!</span>
epoch_int = ~~epoch                                 <span class="hljs-comment">// -&gt; -2085978496</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(epoch_int * <span class="hljs-number">1000</span>))             <span class="hljs-comment">// -&gt;  Wed Nov 25 1903 17:31:44 UTC</span>

<span class="hljs-comment">// that was fun, now let's get real</span>
epoch_flr = <span class="hljs-built_in">Math</span>.floor(epoch)                       <span class="hljs-comment">// -&gt;  2208988800</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(epoch_flr * <span class="hljs-number">1000</span>))             <span class="hljs-comment">// -&gt;  Sun Jan 01 2040 00:00:00 UTC</span>
</code></pre><h5>When the original input wasn’t sanitized</h5><p>Because <code>~~</code> transforms every non-number into <code>0</code>:</p><pre><code class="language-js"><span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~[])   // -&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~NaN)  // -&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~null) // -&gt;</span> <span class="hljs-number">0</span>
</code></pre><p>some programmers treat it as alternative to proper input validation. However, this can lead to strange logic bugs down the line, since you’re no longer distinguishing between invalid inputs and actual <code>0</code> values. This is therefore <em>not</em> a recommended practice.</p><h5>When so many people think <code>~~X == Math.floor(X)</code></h5><p>Most people who write about “double bitwise NOT” incorrectly equate it with <code>Math.floor()</code> for some reason. If you can’t write about it accurately, odds are good you’ll eventually misuse it.</p><p>Others are more careful to mention <code>Math.floor()</code> for positive inputs and <code>Math.ceil()</code> for negative ones, but that forces you to stop and think about the values you’re dealing with. This defeats the purpose of <code>~~</code> as a handy no-gotchas shortcut.</p><h3>DOSAGE</h3><p>Avoid where possible. Use sparingly otherwise.</p><h3>ADMINISTRATION</h3><ol><li>Apply cautiously.</li><li>Sanitize values before applying.</li><li>Carefully document relevant assumptions about the values being transformed.</li><li>Review code to deal with, at minimum:<ul><li>logic bugs where invalid inputs are instead passed to other code modules as valid <code>0</code> values</li><li>range errors on transformed inputs</li><li>fencepost errors due to incorrect rounding direction</li></ul></li></ol></article></div><a id="goto-catalog" href="catalog.html">&lt;&lt;返回目录</a><!-- 多说分享 start --><div class="ds-share flat" data-thread-key="jstips_18" data-title="Truncating the fast (but risky) way" data-images="http://jstips.hingsir.com/dist/images/github.jpg" data-content=".`~~X` is usually a faster `Math.trunc(X)`, but can also make your code do nasty things." data-url="http://jstips.hingsir.com/dist/tips/en/rounding-the-fast-way.html"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li><a class="ds-more" href="javascript:void(0);">分享到：</a></li><li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li><li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li><li><a class="ds-qq" href="javascript:void(0);" data-service="qq">QQ</a></li></ul></div></div><!-- 多说分享 end --><!-- 多说评论框 start --><div class="ds-thread" data-thread-key="jstips_18" data-title="Truncating the fast (but risky) way" data-url="http://jstips.hingsir.com/dist/tips/en/rounding-the-fast-way.html"></div><!-- 多说评论框 end --><!-- 多说公共JS代码 start (一个网页只需插入一次) --><script type="text/javascript">var duoshuoQuery = {short_name:"hingsir"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();</script><!-- 多说公共JS代码 end --><div class="site-footer"><p class="copyright">Powered by <a href="https://github.com/hingsir">@hingsir</a>, 2016</p></div></div></div><a id="forkme" href="https://github.com/hingsir/jstips-site"><img style="position: absolute; top: 0; right: 0; border: 0;z-index:100" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a><script>var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d2663479c9de1b01cbc8485ab8cb623d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();</script></body></html>