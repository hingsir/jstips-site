<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JsTips - Useful JavaScript Tips</title>
    <meta name="keywords" content="jstips,tips,Useful JavaScript Tips">
    <meta name="description" content="Introduces these short and useful daily JavaScript tips that will allow you to improve your code writing. With less than 2 minutes each day, you will be able to read about performance, conventions, hacks, interview questions and all the items that the future of this awesome language holds for us">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scale=no">
    <link rel="icon" type="image/x-icon" href="../../images/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../../css/all.min.css">
    <script type="text/javascript">
        window.onload = function(){
                document.getElementById('J_languages_select').onchange = function(){
                var lang = this.value;
                window.location.href = window.location.href.replace(/tips\/(\w+)\//,function($,$1){
                    return $.replace($1,lang);
                })
            }
        }
    </script>
</head><body>
    <div class="main-content clearfix">
        <div id="sider-wrap" class="catalog">
    <div class="catalog-header">
        <h1>
            <a href="https://github.com/loverajoel/jstips">Useful JS Tips</a>
        </h1>
        <select id="J_languages_select">
            
                <option value="en" >English</option>
            
                <option value="zh_CN" >简体中文</option>
            
                <option value="zh_TW" selected=selected>繁体中文</option>
            
        </select>
    </div>
    <ul>
        
            <li><a href="binding-objects-to-functions" class=""
             title="61.Bind 物件到 function">61.Bind 物件到 function</a></li>
        
            <li><a href="three-useful-hacks" class=""
             title="60.三個有用的 hack">60.三個有用的 hack</a></li>
        
            <li><a href="keyword-var-vs-let" class=""
             title="59.ES6 的 var 和 let">59.ES6 的 var 和 let</a></li>
        
            <li><a href="break-continue-loop-functional" class=""
             title="58.在 functional programming break 或 continue 迴圈">58.在 functional programming break 或 continue 迴圈</a></li>
        
            <li><a href="comma-operaton-in-js" class=""
             title="57.JavaScript 的逗號操作符">57.JavaScript 的逗號操作符</a></li>
        
            <li><a href="copy-to-clipboard" class=""
             title="56.複製到剪貼版">56.複製到剪貼版</a></li>
        
            <li><a href="make-easy-loop-on-array" class=""
             title="55.使用一個陣列建立一個簡單的迴圈">55.使用一個陣列建立一個簡單的迴圈</a></li>
        
            <li><a href="use-optional-arguments" class=""
             title="54.如何使用在函式中的可選參數（包含 callback）">54.如何使用在函式中的可選參數（包含 callback）</a></li>
        
            <li><a href="get-file-extension" class=""
             title="53.取得檔案的副檔名">53.取得檔案的副檔名</a></li>
        
            <li><a href="return-values-with-the-new-operator" class=""
             title="52.使用「new」運算符的回傳值">52.使用「new」運算符的回傳值</a></li>
        
            <li><a href="DOM-event-listening-made-easy" class=""
             title="51.簡單的監聽 DOM 事件">51.簡單的監聽 DOM 事件</a></li>
        
            <li><a href="helpful-console-log-hacks" class=""
             title="50.實用的 Console Logging 技巧">50.實用的 Console Logging 技巧</a></li>
        
            <li><a href="extract-unix-timestamp-easily" class=""
             title="49.在 JavaScript 簡單取得 unix timestamp">49.在 JavaScript 簡單取得 unix timestamp</a></li>
        
            <li><a href="reminders-about-reduce-function-usage" class=""
             title="48.如何 reduce 陣列">48.如何 reduce 陣列</a></li>
        
            <li><a href="basics-declarations" class=""
             title="47.宣告的基本知識">47.宣告的基本知識</a></li>
        
            <li><a href="detect-document-ready-in-pure-js" class=""
             title="46.使用 pure JavaScript 檢查文件是否準備">46.使用 pure JavaScript 檢查文件是否準備</a></li>
        
            <li><a href="calculate-the-max-min-value-from-an-array" class=""
             title="45.從陣列計算最大和最小值">45.從陣列計算最大和最小值</a></li>
        
            <li><a href="know-the-passing-mechanism" class=""
             title="44.了解傳送機制">44.了解傳送機制</a></li>
        
            <li><a href="use-destructuring-in-function-parameters" class=""
             title="43.在函式參數裡使用解構子">43.在函式參數裡使用解構子</a></li>
        
            <li><a href="preventing-unapply-attacks" class=""
             title="42.防止 Unapply 攻擊">42.防止 Unapply 攻擊</a></li>
        
            <li><a href="array-average-and-median" class=""
             title="41.陣列平均值和中間值">41.陣列平均值和中間值</a></li>
        
            <li><a href="using-json-stringify" class=""
             title="40.使用 JSON.Stringify">40.使用 JSON.Stringify</a></li>
        
            <li><a href="advanced-properties" class=""
             title="39.進階 JavaScript 屬性">39.進階 JavaScript 屬性</a></li>
        
            <li><a href="flattening-multidimensional-arrays-in-javascript" class=""
             title="38.在 JavaScript 中將多維陣列扁平化">38.在 JavaScript 中將多維陣列扁平化</a></li>
        
            <li><a href="deduplicate-an-array" class=""
             title="37.移除陣列重複元素">37.移除陣列重複元素</a></li>
        
            <li><a href="observe-dom-changes" class=""
             title="36.觀察在擴充中 DOM 的變化">36.觀察在擴充中 DOM 的變化</a></li>
        
            <li><a href="assignment-shorthands" class=""
             title="35.賦值運算子">35.賦值運算子</a></li>
        
            <li><a href="implementing-asynchronous-loops" class=""
             title="34.實作非同步迴圈">34.實作非同步迴圈</a></li>
        
            <li><a href="create-range-0...n-easily-using-one-line" class=""
             title="33.使用一行程式碼建立一個 `[0, 1, ..., N - 1]` 的陣列">33.使用一行程式碼建立一個 `[0, 1, ..., N - 1]` 的陣列</a></li>
        
            <li><a href="map-to-the-rescue-adding-order-to-object-properties" class=""
             title="32.透過 Map() 在你的物件屬性加入排序">32.透過 Map() 在你的物件屬性加入排序</a></li>
        
            <li><a href="avoid-modifying-or-passing-arguments-into-other-functions—it-kills-optimization" class=""
             title="31.避免修改或傳送 arguments 到其他函式 - 它會影響優化">31.避免修改或傳送 arguments 到其他函式 - 它會影響優化</a></li>
        
            <li><a href="converting-truthy-falsy-values-to-boolean" class=""
             title="30.將 truthy 和 falsy 轉換成布林值">30.將 truthy 和 falsy 轉換成布林值</a></li>
        
            <li><a href="speed-up-recursive-functions-with-memoization" class=""
             title="29.使用 memoization 加速遞迴">29.使用 memoization 加速遞迴</a></li>
        
            <li><a href="curry-vs-partial-application" class=""
             title="28.柯里化（currying）和部分應用程式">28.柯里化（currying）和部分應用程式</a></li>
        
            <li><a href="short-circiut-evaluation-in-js" class=""
             title="27.JavaScript 中的捷徑計算">27.JavaScript 中的捷徑計算</a></li>
        
            <li><a href="filtering-and-sorting-a-list-of-strings" class=""
             title="26.過濾和排序字串清單">26.過濾和排序字串清單</a></li>
        
            <li><a href="Using-immediately-invoked-function-expression" class=""
             title="25.使用立即函式表達式">25.使用立即函式表達式</a></li>
        
            <li><a href="use_===_instead_of_==" class=""
             title="24.使用 === 來替代 ==">24.使用 === 來替代 ==</a></li>
        
            <li><a href="converting-to-number-fast-way" class=""
             title="23.轉換為數字更快的方式">23.轉換為數字更快的方式</a></li>
        
            <li><a href="two-ways-to-empty-an-array" class=""
             title="22.將陣列清空的兩種方法">22.將陣列清空的兩種方法</a></li>
        
            <li><a href="shuffle-an-array" class=""
             title="21.將陣列洗牌">21.將陣列洗牌</a></li>
        
            <li><a href="return-objects-to-enable-chaining-of-functions" class=""
             title="20.回傳物件並使用函式鏈結">20.回傳物件並使用函式鏈結</a></li>
        
            <li><a href="safe-string-concatenation" class=""
             title="19.安全的使用字串串接">19.安全的使用字串串接</a></li>
        
            <li><a href="rounding-the-fast-way" class="cur"
             title="18.Truncating 最快的方式（含有風險）">18.Truncating 最快的方式（含有風險）</a></li>
        
            <li><a href="nodejs-run-a-module-if-it-is-not-required" class=""
             title="17.Node.js - 執行尚未被 required 的模組">17.Node.js - 執行尚未被 required 的模組</a></li>
        
            <li><a href="passing-arguments-to-callback-functions" class=""
             title="16.將參數傳送到 callback 函式">16.將參數傳送到 callback 函式</a></li>
        
            <li><a href="even-simpler-way-of-using-indexof-as-a-contains-clause" class=""
             title="15.更簡單的方式將 indexOf 當作 contains 使用">15.更簡單的方式將 indexOf 當作 contains 使用</a></li>
        
            <li><a href="fat-arrow-functions" class=""
             title="14.箭頭函式">14.箭頭函式</a></li>
        
            <li><a href="tip-to-measure-performance-of-a-javascript-block" class=""
             title="13.測量 JavaScript 程式碼區塊性能的 tip">13.測量 JavaScript 程式碼區塊性能的 tip</a></li>
        
            <li><a href="pseudomandatory-parameters-in-es6-functions" class=""
             title="12.在 ES6 函式內的預設參數">12.在 ES6 函式內的預設參數</a></li>
        
            <li><a href="hoisting" class=""
             title="11.提升變數">11.提升變數</a></li>
        
            <li><a href="check-if-a-property-is-in-a-object" class=""
             title="10.檢查屬性是否存在物件內">10.檢查屬性是否存在物件內</a></li>
        
            <li><a href="template-strings" class=""
             title="09.模板字串">09.模板字串</a></li>
        
            <li><a href="converting-a-node-list-to-an-array" class=""
             title="08.將 Node List 轉換成陣列">08.將 Node List 轉換成陣列</a></li>
        
            <li><a href="use-strict-and-get-lazy" class=""
             title="07.在 JavaScript 使用嚴格模式">07.在 JavaScript 使用嚴格模式</a></li>
        
            <li><a href="writing-a-single-method-for-arrays-and-a-single-element" class=""
             title="06.撰寫一個可以接受單一參數和陣列的方法">06.撰寫一個可以接受單一參數和陣列的方法</a></li>
        
            <li><a href="differences-between-undefined-and-null" class=""
             title="05.undefined 和 null 的差別">05.undefined 和 null 的差別</a></li>
        
            <li><a href="sorting-strings-with-accented-characters" class=""
             title="04.將帶有音節字元的字串進行排序">04.將帶有音節字元的字串進行排序</a></li>
        
            <li><a href="improve-nested-conditionals" class=""
             title="03.改善巢狀化的條件式">03.改善巢狀化的條件式</a></li>
        
            <li><a href="keys-in-children-components-are-important" class=""
             title="02.在子元件 Keys 是很重要的">02.在子元件 Keys 是很重要的</a></li>
        
            <li><a href="angularjs-digest-vs-apply" class=""
             title="01.AngularJs - $digest vs $apply">01.AngularJs - $digest vs $apply</a></li>
        
            <li><a href="insert-item-inside-an-array" class=""
             title="00.在陣列中加入元素">00.在陣列中加入元素</a></li>
        
    </ul>
</div>
        <div id="content-wrap">
             <div id="readme" class="boxed-group clearfix announce instapaper_body md">
 	<article class="markdown-body entry-content" itemprop="mainContentOfPage">
 		<h2>#18 - Truncating 最快的方式（含有風險）</h2>
<blockquote>
<p>2016-01-18 by <a href="https://github.com/pklinger">@pklinger</a></p>
</blockquote>
<p>今天的 tip 是關於性能的部分。</p>
<p><a href="http://stackoverflow.com/questions/5971645/what-is-the-double-tilde-operator-in-javascript">曾經使用過雙波浪</a> <code>~~</code> 運算符嗎？有時候也被稱為 雙 NOT 位元運算符。你可以使用它來替代 <code>Math.trunc()</code> 更為快速。這是為什麼呢？</p>
<p>位元移位運算符 <code>~</code> 將輸入的 32 位元轉換成 <code>-(input + 1)</code>。因此，雙位元移位運算成為更好的工具，將輸入轉換成 <code>-(-(input + 1) + 1)</code> 更趨近 0。對於數字輸入，它類似 <code>Math.trunc()</code>。若失敗的話，則回傳 <code>0</code>，這或許是解決 <code>Math.trunc()</code> 失敗時回傳 <code>NaN</code> 的替代方法。</p>
<pre><code class="language-js"><span class="hljs-comment">// 單 ~</span>
console.<span class="hljs-built_in">log</span>(~<span class="hljs-number">1337</span>)    <span class="hljs-comment">// -1338</span>

<span class="hljs-comment">// 數字輸入</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~47.11)  // -&gt;</span> <span class="hljs-number">47</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~1.9999) // -&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~3)      // -&gt;</span> <span class="hljs-number">3</span>
</code></pre>
<p>雖然 ~~ 可以讓性能更好，但是為了增加程式碼可讀性，請使用 Math.trunc()。如果要了解為什麼，這裡有一些關於 <code>~~</code> 運算子的分析。</p>
<h3>適用情況</h3>
<h5>每個 CPU 的週期次數</h5>
<p><code>~~</code> 整體來說或許比 <code>Math.trunc()</code> 來的快，這種<a href="https://jsperf.com/jsfvsbitnot/10">測試的假設</a>在哪個平台下是很重要的。此外，你通常必須執行數以百萬計的這種操作才可以看到明顯的影響。</p>
<h5>當程式碼的清晰度不是這麼重要時</h5>
<p>如果你想要 confuse 他人，或者從你的 minifier/uglifier 取得最大的效用，這是一個相對廉價的方式。</p>
<h3>禁止的情況</h3>
<h5>當你的程式碼需要維護時</h5>
<p>程式碼的清晰是一直以來都是相當重要的，無論你是不是和一個團隊一起工作，或是對公開的 repo 做 contribute。正如<a href="http://c2.com/cgi/wiki?CodeForTheMaintainer">俗話常說的</a>：</p>
<blockquote>
<p>Always code as if the person who ends up maintaining your code is a violent psychopath who knows where you live.</p>
</blockquote>
<h5>當你忘記 <code>~~</code> 總是趨近於零時</h5>
<p>或許新手開發者更關注在 <code>~~</code> 優秀之處，卻忘記了「只去掉小數點」的重要性。當我們將浮點數轉換成陣列索引，或是相關順序值，這容易導致 <strong>fencepost 錯誤</strong>（a.k.a 「off-by-one」），實際上可能需要不同類型的分數做四捨五入（程式碼缺乏清晰度很容易造成這個問題。）</p>
<p>舉個例子，如果你基於在「最靠近整數」的數字上做計算，你應該使用 <code>Math.round()</code> 而不是 <code>~~</code>，但因為開發者的懶惰往往勝過於冰冷的邏輯，而導致不正確的結果。</p>
<p>相反的，許多名稱類似 <code>Math.xyz()</code> 的函式反而清楚表達他們的功用，減少了錯誤的可能性。</p>
<h5>當處理大量的位元數時</h5>
<p>因為 <code>~</code> 首先是進行 32 位元的轉換，<code>~~</code> 範圍值的結果在 ±2.15 億位元左右。如果你沒有明確的檢查你的輸入範圍，當轉換後的值和原始值有很大的差距時，使用者可能會觸發 unexpected 的行為：</p>
<pre><code class="language-js"><span class="hljs-keyword">a</span> = <span class="hljs-number">2147483647.123</span> <span class="hljs-comment"> // 最大 32 位正整數，再多一點</span>
console.<span class="hljs-built_in">log</span>(~~<span class="hljs-keyword">a</span>)   <span class="hljs-comment"> // -&gt;  2147483647     (ok)</span>
<span class="hljs-keyword">a</span> += <span class="hljs-number">10000</span>         <span class="hljs-comment"> // -&gt;  2147493647.123 (ok)</span>
console.<span class="hljs-built_in">log</span>(~~<span class="hljs-keyword">a</span>)   <span class="hljs-comment"> // -&gt; -2147483648     (huh?)</span>
</code></pre>
<p>一個容易出現問題的地方是在處理 Unix 時間戳記的地方（以秒為單位，從 1970 年 1 月 1 日 00:00:00 UTC）。一個快速取得這個值的方式是：</p>
<pre><code class="language-js">epoch_int = ~~(+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() / <span class="hljs-number">1000</span>)  <span class="hljs-comment">// Date() 以毫秒為單位</span>
</code></pre>
<p>然而，當我們處理在 2038 年 1 月 19 03:14:07 UTC（有時候稱為 <strong>Y2038 limit</strong>）之後的時間戳記，發生可怕的事：</p>
<pre><code class="language-js"><span class="hljs-comment">// 2040 年 1 月 1 日 00:00:00.123 UTC 的時間戳記</span>
epoch = +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2040-01-01'</span>) / <span class="hljs-number">1000</span> + <span class="hljs-number">0.123</span>      <span class="hljs-comment">// -&gt;  2208988800.123</span>

<span class="hljs-comment">// 回到未來！</span>
epoch_int = ~~epoch                                 <span class="hljs-comment">// -&gt; -2085978496</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(epoch_int * <span class="hljs-number">1000</span>))             <span class="hljs-comment">// -&gt;  Wed Nov 25 1903 17:31:44 UTC</span>

<span class="hljs-comment">// 這很有趣，讓我們取得正確的答案</span>
epoch_flr = <span class="hljs-built_in">Math</span>.floor(epoch)                       <span class="hljs-comment">// -&gt;  2208988800</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(epoch_flr * <span class="hljs-number">1000</span>))             <span class="hljs-comment">// -&gt;  Sun Jan 01 2040 00:00:00 UTC</span>
</code></pre>
<h5>當原始輸入值沒經過處理</h5>
<p>因為 <code>~~</code> 將每個非數字轉換成 <code>0</code>：</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~[])   // -&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~NaN)  // -&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~null) // -&gt;</span> <span class="hljs-number">0</span>
</code></pre>
<p>有些開發者把它作為替代輸入驗證。然而，這可能會導致奇怪的邏輯錯誤，你沒辦法區別他們之間誰是無效的輸入，或者是 <code>0</code>。因此這_不是_推薦的做法。</p>
<h5>當許多人認為 <code>~~X == Math.floor(X)</code> 時</h5>
<p>許多人因為錯誤的原因以為「雙位元 NOT」等同於 <code>Math.floor()</code>。如果你沒辦法準確的使用它，最終你可能會濫用它。
有些人很細心地提到 <code>Math.floor()</code> 是用在正數輸入，而 <code>Math.ceil()</code> 是用在負數輸入。但是，這又會強制讓你停下並思考關於你該如何處理數值。這違背了使用 <code>~~</code> 做為方便無害的目的。</p>
<h3>結論</h3>
<p>避免在可能的情況。否則請謹慎使用。</p>
<h3>管理</h3>
<ol>
<li>謹慎使用。</li>
<li>在應用前請先處理數值。</li>
<li>仔細記錄關於數值被轉換的相關假設。</li>
<li>至少檢查程式碼並處理：
<ul>
<li>不正確輸入反而傳送給其他程式碼模組作為有效的 <code>0</code> 的邏輯 Bug。</li>
<li>在轉換輸入的範圍錯誤。</li>
<li>因為不正確的四捨五入方向，造成 fencepost 錯誤。</li>
</ul>
</li>
</ol>
 	</article>
</div>
            <a id="goto-catalog" href="catalog.html">&lt;&lt;返回目录</a>
            <!-- 多说分享 start -->
<div class="ds-share flat" data-thread-key="jstips_18" data-title="Truncating 最快的方式（含有風險）" data-images="http://jstips.hingsir.com/dist/images/github.jpg" data-content="通常 `~~X` 速度比 `Math.trunc(X)` 快，但是會造成你的程式碼變得很混亂。" data-url="http://jstips.hingsir.com/dist/tips/zh_TW/rounding-the-fast-way.html">
    <div class="ds-share-inline">
      <ul  class="ds-share-icons-16">
        <li><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
        <li><a class="ds-qq" href="javascript:void(0);" data-service="qq">QQ</a></li>
      </ul>
    </div>
 </div>
<!-- 多说分享 end -->
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="jstips_18" data-title="Truncating 最快的方式（含有風險）" data-url="http://jstips.hingsir.com/dist/tips/zh_TW/rounding-the-fast-way.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"hingsir"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->            <div class="site-footer">
                <p class="copyright">Powered by <a href="https://github.com/hingsir">@hingsir</a>, 2016</p>
            </div>
        </div>
    </div>
    <a id="forkme" href="https://github.com/hingsir/jstips-site"><img style="position: absolute; top: 0; right: 0; border: 0;z-index:100;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d2663479c9de1b01cbc8485ab8cb623d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script></body>
</html>