<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>JsTips - Useful JavaScript Tips</title><meta name="keywords" content="jstips,tips,Useful JavaScript Tips"><meta name="description" content="Introduces these short and useful daily JavaScript tips that will allow you to improve your code writing. With less than 2 minutes each day, you will be able to read about performance, conventions, hacks, interview questions and all the items that the future of this awesome language holds for us"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scale=no"><link rel="icon" type="image/x-icon" href="../../images/favicon.ico"><link rel="stylesheet" type="text/css" href="../../css/all-7e45beae0a.min.css"><script type="text/javascript">window.onload = function(){
                document.getElementById('J_languages_select').onchange = function(){
                var lang = this.value;
                window.location.href = window.location.href.replace(/tips\/(\w+)\//,function($,$1){
                    return $.replace($1,lang);
                })
            }
        }</script></head><body><div class="main-content clearfix"><div id="sider-wrap" class="catalog"><div class="catalog-header"><h1><a href="https://github.com/loverajoel/jstips">Useful JS Tips</a></h1><select id="J_languages_select"><option value="en">English</option><option value="zh_CN" selected="selected">简体中文</option><option value="zh_TW">繁体中文</option></select></div><ul><li><a href="copy-to-clipboard" class="" title="56.复制到粘贴板">56.复制到粘贴板</a></li><li><a href="make-easy-loop-on-array" class="" title="55.用数组建立一个简单的循环">55.用数组建立一个简单的循环</a></li><li><a href="use-optional-arguments" class="" title="54.函数中如何使用可选参数（包括可选回调函数）">54.函数中如何使用可选参数（包括可选回调函数）</a></li><li><a href="get-file-extension" class="" title="53.取得文件扩展名">53.取得文件扩展名</a></li><li><a href="return-values-with-the-new-operator" class="" title="52.new的返回值">52.new的返回值</a></li><li><a href="DOM-event-listening-made-easy" class="" title="51.简单监听DOM事件">51.简单监听DOM事件</a></li><li><a href="helpful-console-log-hacks" class="" title="50.实用的`log`技巧">50.实用的`log`技巧</a></li><li><a href="extract-unix-timestamp-easily" class="" title="49.简单获取unix时间戳">49.简单获取unix时间戳</a></li><li><a href="reminders-about-reduce-function-usage" class="" title="48.怎样`reduce()`数组">48.怎样`reduce()`数组</a></li><li><a href="basics-declarations" class="" title="47.变量声明">47.变量声明</a></li><li><a href="detect-document-ready-in-pure-js" class="" title="46.纯JS监听document是否加载完成">46.纯JS监听document是否加载完成</a></li><li><a href="calculate-the-max-min-value-from-an-array" class="" title="45.计算数组中的最大值/最小值">45.计算数组中的最大值/最小值</a></li><li><a href="know-the-passing-mechanism" class="" title="44.了解传值机制">44.了解传值机制</a></li><li><a href="use-destructuring-in-function-parameters" class="" title="43.函数参数内使用解构">43.函数参数内使用解构</a></li><li><a href="preventing-unapply-attacks" class="" title="42.预防unapply攻击">42.预防unapply攻击</a></li><li><a href="array-average-and-median" class="" title="41.数组平均值与中值">41.数组平均值与中值</a></li><li><a href="using-json-stringify" class="" title="40.使用JSON.Stringify">40.使用JSON.Stringify</a></li><li><a href="advanced-properties" class="" title="39.Javascript高级特性">39.Javascript高级特性</a></li><li><a href="flattening-multidimensional-arrays-in-javascript" class="" title="38.Javascript多维数组扁平化">38.Javascript多维数组扁平化</a></li><li><a href="deduplicate-an-array" class="" title="37.数组去重">37.数组去重</a></li><li><a href="observe-dom-changes" class="" title="36.扩展插件中观察DOM的变化">36.扩展插件中观察DOM的变化</a></li><li><a href="assignment-shorthands" class="" title="35.赋值技巧">35.赋值技巧</a></li><li><a href="implementing-asynchronous-loops" class="" title="34.实现异步循环">34.实现异步循环</a></li><li><a href="create-range-0...n-easily-using-one-line" class="" title="33.仅用一行生成`[0, 1, ..., N-1]`数列">33.仅用一行生成`[0, 1, ..., N-1]`数列</a></li><li><a href="map-to-the-rescue-adding-order-to-object-properties" class="" title="32.Map()的营救；使对象属性有顺序">32.Map()的营救；使对象属性有顺序</a></li><li><a href="avoid-modifying-or-passing-arguments-into-other-functions—it-kills-optimization" class="" title="31.避免修改和传递`arguments`给其他方法 — 影响优化">31.避免修改和传递`arguments`给其他方法 — 影响优化</a></li><li><a href="converting-truthy-falsy-values-to-boolean" class="" title="30.将truthy/falsy转换为布尔值">30.将truthy/falsy转换为布尔值</a></li><li><a href="speed-up-recursive-functions-with-memoization" class="" title="29.运用存储加速递归 Speed up recursive functions with memoization">29.运用存储加速递归 Speed up recursive functions with memoization</a></li><li><a href="curry-vs-partial-application" class="" title="28.柯里化(currying)与部分应用(partial application)">28.柯里化(currying)与部分应用(partial application)</a></li><li><a href="short-circuit-evaluation-in-js" class="" title="27.JS中的短路求值">27.JS中的短路求值</a></li><li><a href="filtering-and-sorting-a-list-of-strings" class="" title="26.过滤并排序字符串列表">26.过滤并排序字符串列表</a></li><li><a href="Using-immediately-invoked-function-expression" class="" title="25.使用立即执行函数表达式">25.使用立即执行函数表达式</a></li><li><a href="use_===_instead_of_==" class="" title="24.使用 === 而不是 ==">24.使用 === 而不是 ==</a></li><li><a href="converting-to-number-fast-way" class="" title="23.转换为数字的更快方法">23.转换为数字的更快方法</a></li><li><a href="two-ways-to-empty-an-array" class="" title="22.清空数组的两种方法">22.清空数组的两种方法</a></li><li><a href="shuffle-an-array" class="" title="21.对数组洗牌">21.对数组洗牌</a></li><li><a href="return-objects-to-enable-chaining-of-functions" class="" title="20.返回对象，使方法可以链式调用">20.返回对象，使方法可以链式调用</a></li><li><a href="safe-string-concatenation" class="" title="19.安全的字符串拼接">19.安全的字符串拼接</a></li><li><a href="rounding-the-fast-way" class="cur" title="18.快速（但危险）的取整方法">18.快速（但危险）的取整方法</a></li><li><a href="nodejs-run-a-module-if-it-is-not-required" class="" title="17.Node.js - 运行未被引用的模块">17.Node.js - 运行未被引用的模块</a></li><li><a href="passing-arguments-to-callback-functions" class="" title="16.向回调方法传递参数">16.向回调方法传递参数</a></li><li><a href="even-simpler-way-of-using-indexof-as-a-contains-clause" class="" title="15.更简单的使用indexOf实现contains功能">15.更简单的使用indexOf实现contains功能</a></li><li><a href="fat-arrow-functions" class="" title="14.箭头函数">14.箭头函数</a></li><li><a href="tip-to-measure-performance-of-a-javascript-block" class="" title="13.测量javascript代码块性能的小知识">13.测量javascript代码块性能的小知识</a></li><li><a href="pseudomandatory-parameters-in-es6-functions" class="" title="12.ES6中的伪强制参数">12.ES6中的伪强制参数</a></li><li><a href="hoisting" class="" title="11.变量提升">11.变量提升</a></li><li><a href="check-if-a-property-is-in-a-object" class="" title="10.检查某对象是否有某属性">10.检查某对象是否有某属性</a></li><li><a href="template-strings" class="" title="09.模板字符串">09.模板字符串</a></li><li><a href="converting-a-node-list-to-an-array" class="" title="08.将Node List转换为数组(Array)">08.将Node List转换为数组(Array)</a></li><li><a href="use-strict-and-get-lazy" class="" title="07.使用&#34;use strict&#34; 变得懒惰">07.使用&#34;use strict&#34; 变得懒惰</a></li><li><a href="writing-a-single-method-for-arrays-and-a-single-element" class="" title="06.可以接受单参数与数组的方法">06.可以接受单参数与数组的方法</a></li><li><a href="differences-between-undefined-and-null" class="" title="05.undefined与null的区别">05.undefined与null的区别</a></li><li><a href="sorting-strings-with-accented-characters" class="" title="04.排列含音节字母的字符串">04.排列含音节字母的字符串</a></li><li><a href="improve-nested-conditionals" class="" title="03.优化嵌套的条件语句">03.优化嵌套的条件语句</a></li><li><a href="keys-in-children-components-are-important" class="" title="02.子容器的Key是很重要的">02.子容器的Key是很重要的</a></li><li><a href="angularjs-digest-vs-apply" class="" title="01.AngularJs - $digest vs $apply">01.AngularJs - $digest vs $apply</a></li><li><a href="insert-item-inside-an-array" class="" title="00.向数组中插入元素">00.向数组中插入元素</a></li></ul></div><div id="content-wrap"><div id="readme" class="boxed-group clearfix announce instapaper_body md"><article class="markdown-body entry-content" itemprop="mainContentOfPage"><h2 id="-18-">#18 - 快速（但危险）的取整方法</h2><blockquote><p>2016-01-18 by <a href="https://github.com/pklinger">@pklinger</a></p></blockquote><p>本条小知识关于性能...</p><p>你曾遇到过<a href="http://stackoverflow.com/questions/5971645/what-is-the-double-tilde-operator-in-javascript">双波浪线<code>~~</code>操作符</a>吗？它也被称为“双按位非”操作符。你通常可以使用它作为代替<code>Math.trunc()</code>的更快的方法。为什么呢？</p><p>一个按位非操作符<code>~</code>首先将输入<code>input</code>截取为32位，然后将其转换为<code>-(input+1)</code>。因此双按位非操作符将输入转换为<code>-(-(input + 1)+1)</code>，使其成为一个趋向于0取整的好工具。对于数字的输入，它很像<code>Math.trunc()</code>。失败时返回<code>0</code>,这可能在解决<code>Math.trunc()</code>转换错误返回<code>NaN</code>时是一个很好的替代。</p><pre><code class="lang-js"><span class="hljs-comment">// 单个 ~</span>
console.<span class="hljs-built_in">log</span>(~<span class="hljs-number">1337</span>)    <span class="hljs-comment">// -1338</span>

<span class="hljs-comment">// 数字输入</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~47.11)  // -&gt;</span> <span class="hljs-number">47</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~1.9999) // -&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~3)      // -&gt;</span> <span class="hljs-number">3</span>
</code></pre><p>然而, 尽管<code>~~</code>可能有更好的性能，有经验的程序员通常坚持使用<code>Math.trunc()</code>。要明白为什么，这里有一个关于此操作符的冷静分析。</p><h3 id="-">适用的情况</h3><h5 id="-cpu-">当CPU资源很珍贵时</h5><p><code>~~</code>可能在各平台上都比<code>Math.trunc()</code>快，但是你应该在你所关心的所有平台上<a href="https://jsperf.com/jsfvsbitnot/10">测试这种猜想</a>。同样，你通常需要执行数百万这样的操作来看看在运行时有没有明显的影响。</p><h5 id="-">当不需要关心代码清晰度时</h5><p>如果你想迷惑其他人，或者想在<code>minifier/uglifier</code>时取得更大功效，这是一种相对廉价的方式。</p><h3 id="-">禁用的情况</h3><h5 id="-">当你的代码需要维护时</h5><p>代码可读性始终是最重要的。无论你工作在一个团队，或是贡献给开源仓库，或是单飞。正如<a href="http://c2.com/cgi/wiki?CodeForTheMaintainer">名言所说</a>：</p><blockquote><p>Always code as if the person who ends up maintaining your code is a violent psychopath who knows where you live.(写代码时，要始终认为一个有暴力倾向并知道你住在哪里的人会最终维护你的代码。)</p></blockquote><p>For a solo programmer, that psychopath is inevitably &quot;you in six months&quot;.（这句不会翻译……）</p><h5 id="-0-">当你忘记<code>~~</code>永远趋向于0时</h5><p>新手程序员或许更关注<code>~~</code>的聪明之处，却忘记了“只去掉小数部分”的意义。这在将浮点数转换为数组索引或关联有序的值时很容易导致<strong>差一错误</strong> ，这时明显需要一个不同的取整方法。 （代码可读性不高往往会导致此问题）</p><p>打个比方，如果你想得到离一个数“最近的整数”，你应该用<code>Math.round()</code>而不是<code>~~</code>，但是由于程序员的惰性和<strong><em>每次使用需要敲10个键</em></strong>的事实，人类的手指往往会战胜冷冷的逻辑，导致错误的结果。</p><p>相比之下，<code>Math.xyz()</code>（举例）函数的名字清楚的传达了它们的作用，减少了可能出现的意外的错误。</p><h5 id="-">当处理大数时</h5><p>因为<code>~</code>首先将数组转换为32位，<code>~~</code>的结果伪值在 &plusmn;2.15*10^12左右。如果你没有明确的检查输入值的范围，当转换的值最终与原始值有很大差距时，用户就可能触发未知的行为：</p><pre><code class="lang-js"><span class="hljs-keyword">a</span> = <span class="hljs-number">2147483647.123</span> <span class="hljs-comment"> // 比32位最大正数，再多一点</span>
console.<span class="hljs-built_in">log</span>(~~<span class="hljs-keyword">a</span>)   <span class="hljs-comment"> // -&gt;  2147483647     (ok)</span>
<span class="hljs-keyword">a</span> += <span class="hljs-number">10000</span>         <span class="hljs-comment"> // -&gt;  2147493647.123 (ok)</span>
console.<span class="hljs-built_in">log</span>(~~<span class="hljs-keyword">a</span>)   <span class="hljs-comment"> // -&gt; -2147483648     (huh?)</span>
</code></pre><p>一个特别容易中招的地方是在处理Unix时间戳时(从1970年1月1日 00:00:00 UTC开始以秒测量)。一个快速获取的方法:</p><pre><code class="lang-js">epoch_int = ~~(+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() / <span class="hljs-number">1000</span>)  <span class="hljs-comment">// Date() 以毫秒计量，所以我们缩小它</span>
</code></pre><p>然而，当处理2038年1月19日 03:14:07 UTC 之后的时间戳时（有时称为<strong>Y2038 limit</strong>）, 可怕的事情发生了：</p><pre><code class="lang-js"><span class="hljs-comment">// 2040年1月1日 00:00:00.123 UTC的时间戳</span>
epoch = +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2040-01-01'</span>) / <span class="hljs-number">1000</span> + <span class="hljs-number">0.123</span>  <span class="hljs-comment">// -&gt;  2208988800.123</span>

<span class="hljs-comment">// 回到未来!</span>
epoch_int = ~~epoch                                 <span class="hljs-comment">// -&gt; -2085978496</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(epoch_int * <span class="hljs-number">1000</span>))             <span class="hljs-comment">// -&gt;  Wed Nov 25 1903 17:31:44 UTC</span>

<span class="hljs-comment">// 这很搞笑，让我们来取得正确答案</span>
epoch_flr = <span class="hljs-built_in">Math</span>.floor(epoch)                       <span class="hljs-comment">// -&gt;  2208988800</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(epoch_flr * <span class="hljs-number">1000</span>))             <span class="hljs-comment">// -&gt;  Sun Jan 01 2040 00:00:00 UTC</span>
</code></pre><h5 id="-">当原始输入的数据类型不确定时</h5><p>因为<code>~~</code>可以将任何非数字类型转换为<code>0</code>：</p><pre><code class="lang-js"><span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~[])   // -&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~NaN)  // -&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-title">console</span>.<span class="hljs-built_in">log</span>(~~null) // -&gt;</span> <span class="hljs-number">0</span>
</code></pre><p>一些程序员将其看作适当输入验证的替代品。然而，这将导致奇怪的逻辑问题，因此你不能辨别违法输入还是真正的<code>0</code>。因此这<em>并不</em>推荐。</p><h5 id="-x-math-floor-x-">当很多人认为<code>~~X == Math.floor(X)</code>时</h5><p>很多人由于很多原因错误的把&quot;双按位非&quot;等同于<code>Math.floor()</code>。如果你不能准确地使用它，最终你很有可能会滥用它。</p><p>另一些人很细心的注意正数使用<code>Math.floor()</code>而负数使用<code>Math.ceil()</code>，但这又强制你在处理它的时候需要停下来想一想你处理的数是什么值。这又违背了使用<code>~~</code>快捷无陷阱的目的。</p><h3 id="-">结论</h3><p>尽量避免，并有节制的使用。</p><h3 id="-">使用</h3><ol><li>谨慎使用。</li><li>在应用前检查值。</li><li>仔细记录被转化值的相关假设。</li><li>审查代码至少处理：<ul><li>逻辑错误，不合法的输入作为合法的<code>0</code>传入其他代码模块</li><li>输入转换后范围错误</li><li>错误的舍入方向导致差一错误</li></ul></li></ol></article></div><a id="goto-catalog" href="catalog.html">&lt;&lt;返回目录</a><!-- 多说分享 start --><div class="ds-share flat" data-thread-key="jstips_18" data-title="快速（但危险）的取整方法" data-images="http://jstips.hingsir.com/dist/images/github.jpg" data-content="通常情况下`~~X`比`Math.trunc(X)`要快，但同时也会使你的代码做一些讨厌的事情。" data-url="http://jstips.hingsir.com/dist/tips/zh_CN/rounding-the-fast-way.html"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li><a class="ds-more" href="javascript:void(0);">分享到：</a></li><li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li><li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li><li><a class="ds-qq" href="javascript:void(0);" data-service="qq">QQ</a></li></ul></div></div><!-- 多说分享 end --><!-- 多说评论框 start --><div class="ds-thread" data-thread-key="jstips_18" data-title="快速（但危险）的取整方法" data-url="http://jstips.hingsir.com/dist/tips/zh_CN/rounding-the-fast-way.html"></div><!-- 多说评论框 end --><!-- 多说公共JS代码 start (一个网页只需插入一次) --><script type="text/javascript">var duoshuoQuery = {short_name:"hingsir"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();</script><!-- 多说公共JS代码 end --><div class="site-footer"><p class="copyright">Powered by <a href="https://github.com/hingsir">@hingsir</a>, 2016</p></div></div></div><a id="forkme" href="https://github.com/hingsir/jstips-site"><img style="position: absolute; top: 0; right: 0; border: 0;z-index:100" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a><script>var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d2663479c9de1b01cbc8485ab8cb623d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();</script></body></html>